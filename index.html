<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const resultBox = document.getElementById('result');
  const snapBtn = document.getElementById("snap");
  const cover = document.getElementById('cover');
  const main = document.getElementById('main');
  let model;
  let currentStream = null;

  // å°é¢ â†’ ä¸»ç•«é¢
  async function enterSystem() {
    stopCamera(); // æ¯æ¬¡é‡æ–°å˜—è©¦å‰å…ˆåœæ‰ç›¸æ©Ÿ
    cover.style.animation = "fadeOut 1s ease forwards";
    setTimeout(() => {
      cover.style.display = "none";
      main.style.display = "flex";
      main.style.opacity = "1";
      loadCameraAndModel();
    }, 1000);
  }

  // å›åˆ°å°é¢ + è‡ªå‹•é‡æ–°æ•´ç†
  function backToCover(message) {
    stopCamera();
    main.style.display = "none";
    cover.style.display = "flex";
    cover.style.animation = "fadeIn 1s ease forwards";
    alert(message + "\nè«‹å…è¨±ä½¿ç”¨ç›¸æ©Ÿå†è©¦ä¸€æ¬¡ã€‚");

    // ç­‰å¾…å‹•ç•«çµæŸå†é‡æ–°æ•´ç†
    setTimeout(() => {
      location.reload();
    }, 800);
  }

  // é—œé–‰æ”å½±æ©Ÿä¸²æµ
  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    video.srcObject = null;
  }

  // é–‹å•Ÿé¡é ­èˆ‡è¼‰å…¥æ¨¡å‹
  async function loadCameraAndModel() {
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = currentStream;
    } catch (err) {
      console.error("é¡é ­å­˜å–å¤±æ•—ï¼š", err);
      backToCover("âš ï¸ ç„¡æ³•é–‹å•Ÿé¡é ­" );
      return;
    }

    resultBox.style.display = "block";
    resultBox.className = "trash";
    resultBox.innerText = "â³ æ¨¡å‹è¼‰å…¥ä¸­...";

    try {
      const modelURL = "./model/model.json";
      const metadataURL = "./model/metadata.json";
      model = await window.tmImage.load(modelURL, metadataURL);

      snapBtn.disabled = false;
      resultBox.className = "recycle";
      resultBox.innerText = "âœ… æ¨¡å‹è¼‰å…¥å®Œæˆï¼Œå¯ä»¥é–‹å§‹æ‹ç…§åˆ†é¡ï¼";
    } catch (err) {
      console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š", err);
      backToCover("âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª model è³‡æ–™å¤¾æ˜¯å¦æ­£ç¢ºã€‚");
    }
  }

  // æ‹ç…§èˆ‡åˆ†é¡
  snapBtn.addEventListener("click", async () => {
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (!model) {
      resultBox.style.display = "block";
      resultBox.className = "hazard";
      resultBox.innerText = "âš ï¸ æ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆ";
      return;
    }

    try {
      const prediction = await model.predict(canvas);
      let best = prediction[0];
      prediction.forEach(p => {
        if (p.probability > best.probability) best = p;
      });

      let cssClass = "trash", icon = "ğŸ—‘ï¸";
      if (best.className.includes("å¯å›æ”¶")) { cssClass = "recycle"; icon = "â™»ï¸"; }
      else if (best.className.includes("æœ‰å®³")) { cssClass = "hazard"; icon = "â˜ ï¸"; }

      resultBox.className = cssClass;
      resultBox.style.display = "block";
      resultBox.innerText = `${icon} åˆ†é¡çµæœï¼š${best.className} (${(best.probability*100).toFixed(2)}%)`;
    } catch (err) {
      console.error("åˆ†é¡å¤±æ•—ï¼š", err);
      resultBox.style.display = "block";
      resultBox.className = "hazard";
      resultBox.innerText = "âš ï¸ åˆ†é¡éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
    }
  });
</script>
