<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const resultBox = document.getElementById('result');
  const snapBtn = document.getElementById("snap");
  const cover = document.getElementById('cover');
  const main = document.getElementById('main');
  let model;
  let currentStream = null;

  // 封面 → 主畫面
  async function enterSystem() {
    stopCamera(); // 每次重新嘗試前先停掉相機
    cover.style.animation = "fadeOut 1s ease forwards";
    setTimeout(() => {
      cover.style.display = "none";
      main.style.display = "flex";
      main.style.opacity = "1";
      loadCameraAndModel();
    }, 1000);
  }

  // 回到封面 + 自動重新整理
  function backToCover(message) {
    stopCamera();
    main.style.display = "none";
    cover.style.display = "flex";
    cover.style.animation = "fadeIn 1s ease forwards";
    alert(message + "\n請允許使用相機再試一次。");

    // 等待動畫結束再重新整理
    setTimeout(() => {
      location.reload();
    }, 800);
  }

  // 關閉攝影機串流
  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    video.srcObject = null;
  }

  // 開啟鏡頭與載入模型
  async function loadCameraAndModel() {
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = currentStream;
    } catch (err) {
      console.error("鏡頭存取失敗：", err);
      backToCover("⚠️ 無法開啟鏡頭" );
      return;
    }

    resultBox.style.display = "block";
    resultBox.className = "trash";
    resultBox.innerText = "⏳ 模型載入中...";

    try {
      const modelURL = "./model/model.json";
      const metadataURL = "./model/metadata.json";
      model = await window.tmImage.load(modelURL, metadataURL);

      snapBtn.disabled = false;
      resultBox.className = "recycle";
      resultBox.innerText = "✅ 模型載入完成，可以開始拍照分類！";
    } catch (err) {
      console.error("模型載入失敗：", err);
      backToCover("❌ 模型載入失敗，請確認 model 資料夾是否正確。");
    }
  }

  // 拍照與分類
  snapBtn.addEventListener("click", async () => {
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (!model) {
      resultBox.style.display = "block";
      resultBox.className = "hazard";
      resultBox.innerText = "⚠️ 模型尚未載入完成";
      return;
    }

    try {
      const prediction = await model.predict(canvas);
      let best = prediction[0];
      prediction.forEach(p => {
        if (p.probability > best.probability) best = p;
      });

      let cssClass = "trash", icon = "🗑️";
      if (best.className.includes("可回收")) { cssClass = "recycle"; icon = "♻️"; }
      else if (best.className.includes("有害")) { cssClass = "hazard"; icon = "☠️"; }

      resultBox.className = cssClass;
      resultBox.style.display = "block";
      resultBox.innerText = `${icon} 分類結果：${best.className} (${(best.probability*100).toFixed(2)}%)`;
    } catch (err) {
      console.error("分類失敗：", err);
      resultBox.style.display = "block";
      resultBox.className = "hazard";
      resultBox.innerText = "⚠️ 分類過程發生錯誤：" + err.message;
    }
  });
</script>
